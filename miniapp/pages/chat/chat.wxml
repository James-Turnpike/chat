<view class="page">
  <view class="header" bindtap="scrollToBottom">
    <text class="title">Daze 聊天室</text>
    <text class="clear" bindtap="onClear">清屏</text>
  </view>
  <scroll-view 
    class="messages" 
    scroll-y="true" 
    scroll-with-animation="{{scrollAnim}}" 
    scroll-into-view="{{lastId}}" 
    bindscroll="onScroll" 
    bindscrolltolower="onScrollToLower" 
    lower-threshold="100"
    enable-back-to-top="true"
    enhanced="{{true}}"
    show-scrollbar="{{false}}"
  >
    <view wx:if="{{!connected}}" class="status-bar {{connected ? 'connected' : ''}}">
      <text>{{connected ? '已连接' : '正在连接'}}</text><text wx:if="{{!connected}}" class="dots">...</text>
    </view>
    
    <view wx:if="{{messages.length === 0 && connected}}" class="empty-state">
      <text>暂无消息，快来聊聊吧~</text>
    </view>

    <view class="message-list">
      <block wx:for="{{messages}}" wx:key="id">
        <view wx:if="{{item.type === 'sep'}}" id="msg-{{item.id}}" class="day-sep">
          <text class="sep">{{item.label}}</text>
        </view>
        
        <view wx:else id="msg-{{item.id}}" class="msg {{item.self ? 'self' : 'other'}}" hover-class="none">
          <view class="avatar" style="background: {{item.avatarColor}}; color: {{item.avatarTextColor}}">
            {{item.avatarChar}}
          </view>
          <view class="content">
            <view class="nick" wx:if="{{!item.self}}">{{item.nick}}</view>
            <view class="bubble-row">
              <view class="bubble" bindlongpress="onCopy" data-text="{{item.text}}" hover-class="bubble-hover" hover-stay-time="100">
                <text selectable="true">{{item.text}}</text>
              </view>
              <text class="time">{{item.time}}</text>
            </view>
          </view>
        </view>
      </block>
    </view>
  </scroll-view>

  <view wx:if="{{showToBottom}}" class="to-bottom-btn {{unreadCount > 0 ? 'has-unread' : ''}}" bindtap="scrollToBottom">
    <text class="btn-text">{{unreadCount > 0 ? unreadCount + ' 条新消息' : '回到底部'}}</text>
    <view class="arrow-down"></view>
  </view>
  <view class="input-bar">
    <input
      class="input"
      type="text"
      placeholder="{{connected ? '输入消息（回车发送）...' : '正在连接...'}}"
      placeholder-class="placeholder"
      confirm-type="send"
      focus="{{focus}}"
      maxlength="500"
      value="{{inputValue}}"
      bindinput="onInput"
      bindconfirm="onSend"
      bindfocus="onFocusInput"
      adjust-position="{{true}}"
      hold-keyboard="{{true}}"
    />
    <text class="counter {{counterLevel}}" wx:if="{{inputValue.length > 0}}">{{inputValue.length}}/500</text>
    <button class="send {{!inputValue || !connected ? 'disabled' : ''}}" bindtap="onSend" disabled="{{!inputValue || !connected}}">发送</button>
  </view>
</view>
